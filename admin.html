<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå° - SAMPSONç§‘ç ”å®éªŒç»„</title>
    <link rel="stylesheet" href="style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Cinzel', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1a3e3e 0%, #0d2020 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .admin-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }
        .admin-header {
            background: linear-gradient(135deg, #1a3e3e, #2d6b6b);
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .admin-header h1 {
            color: white;
            font-size: 20px;
        }
        .admin-header .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .admin-header .username {
            color: rgba(255,255,255,0.9);
            font-weight: 600;
        }
        .admin-header .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .admin-header .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        .admin-body {
            padding: 30px;
        }
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
            color: #1a3e3e;
        }
        .stat-card .label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        .section-title {
            font-size: 18px;
            color: #1a3e3e;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1a3e3e;
        }
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .user-table th,
        .user-table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .user-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        .user-table tr:hover {
            background: #f8f9fa;
        }
        .user-table .role-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .user-table .role-admin {
            background: #ffebee;
            color: #c62828;
        }
        .user-table .role-user {
            background: #e3f2fd;
            color: #1565c0;
        }
        .user-table .delete-btn {
            background: #ff5252;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .user-table .delete-btn:hover {
            background: #ff1744;
        }
        .add-user-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        .add-user-form h3 {
            margin-bottom: 15px;
            color: #333;
        }
        .add-user-form .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .add-user-form input,
        .add-user-form select {
            flex: 1;
            min-width: 150px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        .add-user-form input:focus,
        .add-user-form select:focus {
            outline: none;
            border-color: #1a3e3e;
        }
        .add-user-form .submit-btn {
            background: #1a3e3e;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        .add-user-form .submit-btn:hover {
            background: #2d6b6b;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #1a3e3e;
            text-decoration: none;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .message.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .message.error {
            background: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>ğŸ”§ ç®¡ç†åå°</h1>
            <div class="user-info">
                <span class="username" id="admin-name">ç®¡ç†å‘˜</span>
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>
        
        <div class="admin-body">
            <a href="/" class="back-link">â† è¿”å›é¦–é¡µ</a>
            
            <div id="message" class="message hidden"></div>
            
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="number" id="total-users">-</div>
                    <div class="label">æ€»ç”¨æˆ·æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="total-admins">-</div>
                    <div class="label">ç®¡ç†å‘˜æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="total-members">-</div>
                    <div class="label">æ™®é€šæˆå‘˜æ•°</div>
                </div>
            </div>
            
            <h2 class="section-title">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>
            
            <div class="add-user-form">
                <h3>â• æ·»åŠ æ–°ç”¨æˆ·</h3>
                <form id="add-user-form" onsubmit="addUser(event)">
                    <div class="form-row">
                        <input type="text" id="new-username" placeholder="ç”¨æˆ·å" required minlength="3">
                        <input type="password" id="new-password" placeholder="å¯†ç " required minlength="6">
                        <select id="new-role">
                            <option value="user">æ™®é€šæˆå‘˜</option>
                            <option value="admin">ç®¡ç†å‘˜</option>
                        </select>
                        <button type="submit" class="submit-btn">æ·»åŠ ç”¨æˆ·</button>
                    </div>
                </form>
            </div>
            
            <table class="user-table">
                <thead>
                    <tr>
                        <th>ç”¨æˆ·å</th>
                        <th>è§’è‰²</th>
                        <th>æ³¨å†Œæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="user-list">
                    <tr><td colspan="4">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkAuth() {
            try {
                const res = await fetch('/api/user', {credentials: 'include'});
                const data = await res.json();
                
                if (!data.authenticated || !data.isAdmin) {
                    window.location.href = '/login.html';
                    return false;
                }
                
                document.getElementById('admin-name').textContent = data.username;
                return true;
            } catch (err) {
                window.location.href = '/login.html';
                return false;
            }
        }
        
        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers() {
            try {
                const res = await fetch('/api/users', {credentials: 'include'});
                const data = await res.json();
                
                if (!data.success) {
                    showMessage(data.message || 'åŠ è½½å¤±è´¥', 'error');
                    return;
                }
                
                const users = data.users || [];
                document.getElementById('total-users').textContent = users.length;
                document.getElementById('total-admins').textContent = users.filter(u => u.role === 'admin').length;
                document.getElementById('total-members').textContent = users.filter(u => u.role === 'user').length;
                
                const tbody = document.getElementById('user-list');
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999;">æš‚æ— ç”¨æˆ·</td></tr>';
                    return;
                }
                
                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td><strong>${escapeHtml(u.username)}</strong></td>
                        <td><span class="role-badge ${u.role === 'admin' ? 'role-admin' : 'role-user'}">${u.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æˆå‘˜'}</span></td>
                        <td>${new Date(u.createdAt).toLocaleString('zh-CN')}</td>
                        <td>
                            ${u.username !== 'admin' ? `<button class="delete-btn" onclick="deleteUser('${u.username}')">åˆ é™¤</button>` : '-'}
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                showMessage('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥', 'error');
            }
        }
        
        // æ·»åŠ ç”¨æˆ·
        async function addUser(e) {
            e.preventDefault();
            const username = document.getElementById('new-username').value.trim();
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;
            
            try {
                const res = await fetch('/api/admin/add-user', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({username, password, role})
                });
                const data = await res.json();
                
                if (data.success) {
                    showMessage('ç”¨æˆ·æ·»åŠ æˆåŠŸï¼', 'success');
                    document.getElementById('add-user-form').reset();
                    loadUsers();
                } else {
                    showMessage(data.message || 'æ·»åŠ å¤±è´¥', 'error');
                }
            } catch (err) {
                showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        }
        
        // åˆ é™¤ç”¨æˆ·
        async function deleteUser(username) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${username}" å—ï¼Ÿ`)) return;
            
            try {
                const res = await fetch('/api/admin/delete-user', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({username})
                });
                const data = await res.json();
                
                if (data.success) {
                    showMessage('ç”¨æˆ·å·²åˆ é™¤', 'success');
                    loadUsers();
                } else {
                    showMessage(data.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (err) {
                showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        }
        
        // é€€å‡ºç™»å½•
        async function logout() {
            await fetch('/api/logout', {method: 'POST', credentials: 'include'});
            window.location.href = '/login.html';
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = 'message ' + type;
        }
        
        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // åˆå§‹åŒ–
        (async () => {
            if (await checkAuth()) {
                loadUsers();
            }
        })();
    </script>
</body>
</html>
